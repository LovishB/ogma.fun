<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ogma Token Creator</title>
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Material CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #8A2BE2, #FF69B4);
            color: #333;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            padding: 20px;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            background-color: rgba(255, 255, 255, 0.9);
            border: 2px solid #FF69B4;
            overflow: hidden;
            position: relative;
        }
        .card:before {
            content: "";
            position: absolute;
            top: -10px;
            right: -10px;
            width: 80px;
            height: 80px;
            background: #FFD700;
            border-radius: 50%;
            opacity: 0.6;
            z-index: 0;
        }
        .card-title {
            font-weight: 700;
            color: #8A2BE2;
            font-size: 1.8rem;
        }
        .btn-connect {
            background-color: #FF69B4;
            border-radius: 30px;
            padding: 0 25px;
            box-shadow: 0 5px 15px rgba(255, 105, 180, 0.4);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }
        .btn-connect:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 105, 180, 0.6);
            background-color: #FF1493;
        }
        .btn-create {
            background-color: #8A2BE2;
            border-radius: 30px;
            padding: 0 25px;
            box-shadow: 0 5px 15px rgba(138, 43, 226, 0.4);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }
        .btn-create:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(138, 43, 226, 0.6);
            background-color: #7B68EE;
        }
        .status-message {
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            font-weight: 500;
            animation: fadeIn 0.5s ease;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        .info {
            background-color: #e2f3f5;
            color: #0c5460;
            border: 2px solid #bee5eb;
        }
        .hidden {
            display: none;
        }
        .loader {
            display: inline-block;
            width: 25px;
            height: 25px;
            margin-right: 8px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #FF69B4;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .wallet-info {
            font-size: 16px;
            color: #6c5ce7;
            margin-bottom: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            animation: slideIn 0.5s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .wallet-info i {
            color: #FF69B4;
            margin-right: 10px;
        }
        .header {
            margin-bottom: 30px;
            text-align: center;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            animation: float 6s ease-in-out infinite;
        }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }
        .header h4 {
            color: white;
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: 1px;
        }
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .badge-sepolia {
            background-color: #FFD700;
            color: #333;
        }
        .modal {
            border-radius: 20px;
            max-width: 500px;
            background: linear-gradient(135deg, #fff, #f0f0ff);
        }
        .modal-content h4 {
            color: #8A2BE2;
            display: flex;
            align-items: center;
        }
        .modal-content h4 i {
            margin-right: 10px;
            color: #4CAF50;
        }
        .modal-footer {
            padding: 15px 20px;
            text-align: right;
        }
        .eth-address {
            font-family: monospace;
            background: #f7f7ff;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            word-break: break-all;
            border-left: 4px solid #FF69B4;
        }
        .input-field input:focus {
            border-bottom: 1px solid #FF69B4 !important;
            box-shadow: 0 1px 0 0 #FF69B4 !important;
        }
        .input-field input:focus + label {
            color: #FF69B4 !important;
        }
        .input-field textarea:focus {
            border-bottom: 1px solid #FF69B4 !important;
            box-shadow: 0 1px 0 0 #FF69B4 !important;
        }
        .input-field textarea:focus + label {
            color: #FF69B4 !important;
        }
        .card-content {
            z-index: 1;
            position: relative;
        }
        .rocket {
            position: absolute;
            top: -50px;
            right: -30px;
            font-size: 5rem;
            opacity: 0.2;
            transform: rotate(45deg);
        }
        .moon {
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-size: 3rem;
            color: #FFD700;
            opacity: 0.7;
            z-index: -1;
        }
        .coin {
            position: fixed;
            animation: floatCoin 8s ease-in-out infinite;
            color: #FFD700;
            font-size: 2rem;
            opacity: 0.6;
            z-index: -1;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            transform-origin: center;
        }
        
        /* Different animation durations for more variety */
        .coin1, .coin4, .coin7, .coin10, .coin13 { animation-duration: 7s; }
        .coin2, .coin5, .coin8, .coin11, .coin14 { animation-duration: 8s; }
        .coin3, .coin6, .coin9, .coin12, .coin15 { animation-duration: 9s; }
        .coin1 { top: 10%; left: 5%; animation-delay: 0s; }
        .coin2 { top: 20%; right: 10%; animation-delay: 1s; }
        .coin3 { bottom: 15%; left: 15%; animation-delay: 2s; }
        .coin4 { top: 30%; left: 25%; animation-delay: 0.5s; }
        .coin5 { top: 15%; right: 20%; animation-delay: 1.5s; }
        .coin6 { bottom: 25%; left: 35%; animation-delay: 2.5s; }
        .coin7 { top: 45%; right: 15%; animation-delay: 3s; }
        .coin8 { bottom: 40%; right: 25%; animation-delay: 3.5s; }
        .coin9 { top: 60%; left: 10%; animation-delay: 4s; }
        .coin10 { top: 5%; right: 30%; animation-delay: 0.2s; }
        .coin11 { top: 70%; right: 5%; animation-delay: 1.7s; }
        .coin12 { bottom: 10%; right: 35%; animation-delay: 2.3s; }
        .coin13 { top: 25%; left: 45%; animation-delay: 1.2s; }
        .coin14 { top: 50%; right: 40%; animation-delay: 2.8s; }
        .coin15 { bottom: 30%; left: 3%; animation-delay: 3.2s; }
        
        @keyframes floatCoin {
            0% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-15px) rotate(5deg); }
            50% { transform: translateY(-30px) rotate(10deg); }
            75% { transform: translateY(-15px) rotate(5deg); }
            100% { transform: translateY(0) rotate(0deg); }
        }
        .input-field {
            margin-bottom: 25px;
        }
        #tx-link {
            background-color: #FFD700;
            color: #333;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(255, 215, 0, 0.4);
            border-radius: 30px;
            margin-top: 10px;
            transition: all 0.3s ease;
        }
        #tx-link:hover {
            background-color: #FFC107;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 215, 0, 0.6);
        }
    </style>
</head>
<body>
    <div class="moon">üåï</div>
    <div class="coin coin1">üí∞</div>
    <div class="coin coin2">ü™ô</div>
    <div class="coin coin3">üíé</div>
    <div class="coin coin4">üí∏</div>
    <div class="coin coin5">üöÄ</div>
    <div class="coin coin6">‚≠ê</div>
    <div class="coin coin7">üí∞</div>
    <div class="coin coin8">ü™ô</div>
    <div class="coin coin9">üíé</div>
    <div class="coin coin10">üî•</div>
    <div class="coin coin11">üå†</div>
    <div class="coin coin12">üíØ</div>
    <div class="coin coin13">ü§ë</div>
    <div class="coin coin14">üíµ</div>
    <div class="coin coin15">üåü</div>
    
    <div class="container">
        <div class="header center-align">
            <h4>üöÄ Ogma Token Creator <span class="badge badge-sepolia">Sepolia</span></h4>
            <p>Create your own memecoin and launch to the moon! üåï</p>
        </div>

        <div class="card">
            <div class="card-content">
                <span class="rocket">üöÄ</span>
                <span class="card-title">Create Your Memecoin</span>
                
                <!-- Connect Wallet Section -->
                <div class="section">
                    <button id="connect-wallet" class="waves-effect waves-light btn btn-connect">
                        <i class="material-icons left">account_balance_wallet</i>Connect Wallet
                    </button>
                <div id="wallet-info" class="wallet-info hidden">
                        <i class="material-icons">account_balance_wallet</i> Connected: <span id="wallet-address" class="eth-address"></span>
                    </div>
                </div>

                <!-- Token Creation Form -->
                <div id="token-form" class="section hidden">
                    <div class="row">
                        <div class="input-field col s12">
                            <input id="token-name" type="text" class="validate">
                            <label for="token-name">Token Name</label>
                            <span class="helper-text">E.g., "RocketDoge" or "MoonLambo"</span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <input id="token-symbol" type="text" class="validate">
                            <label for="token-symbol">Token Symbol</label>
                            <span class="helper-text">E.g., "RKTDG" or "MLMBO" (2-5 characters)</span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <input id="token-uri" type="text" class="validate">
                            <label for="token-uri">Token URI</label>
                            <span class="helper-text">Link to your memecoin logo/mascot</span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <textarea id="token-description" class="materialize-textarea"></textarea>
                            <label for="token-description">Token Description</label>
                            <span class="helper-text">What makes your memecoin special? Get creative!</span>
                        </div>
                    </div>
                    <button id="create-token" class="waves-effect waves-light btn btn-create">
                        <i class="material-icons left">rocket_launch</i>Launch Token
                    </button>
                </div>

                <!-- Status Messages -->
                <div id="status-message" class="status-message hidden"></div>
            </div>
        </div>
    </div>

    <!-- Transaction Success Modal -->
            <div id="tx-success-modal" class="modal">
        <div class="modal-content">
            <h4><i class="material-icons">rocket_launch</i>Your Memecoin Has Launched! üöÄ</h4>
            <p>Your Ogma token is now on the blockchain and ready to moon!</p>
            <div class="section">
                <h6>Token Address:</h6>
                <p id="new-token-address" class="eth-address"></p>
            </div>
            <div class="section">
                <h6>Transaction Hash:</h6>
                <p id="tx-hash" class="eth-address"></p>
                <a id="tx-link" href="#" target="_blank" class="waves-effect waves-light btn hidden">
                    <i class="material-icons left">open_in_new</i>View on Etherscan
                </a>
            </div>
            <p>üîí 60% of your tokens are locked for 30 days, and 40% are in your wallet ready to use!</p>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
        </div>
    </div>

    <!-- jQuery and Materialize JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <!-- Ethers.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.8.0/ethers.umd.min.js"></script>

    <script>
        // Constants
        const OGMA_FACTORY_ADDRESS = '0xCE86EF8A6e62a074AAc72207eBCa824FE288e6E1';
        const SEPOLIA_RPC_URL = 'https://eth-sepolia.g.alchemy.com/v2/KfeSu5q27FaoFJqNzanj3VemrijlRuUM';
        
        // Contract ABI for the OgmaFactory (simplified to include only what we need)
        const FACTORY_ABI = [
            {
                "inputs": [
                    {"internalType": "string", "name": "_tokenName", "type": "string"},
                    {"internalType": "string", "name": "_tokenSymbol", "type": "string"},
                    {"internalType": "string", "name": "_tokenURI", "type": "string"},
                    {"internalType": "string", "name": "_tokenDescription", "type": "string"}
                ],
                "name": "createToken",
                "outputs": [{"internalType": "address", "name": "", "type": "address"}],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];

        // Global variables
        let provider, signer, factoryContract;
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Materialize components
            M.Modal.init(document.querySelectorAll('.modal'));
            
            // Add event listeners
            document.getElementById('connect-wallet').addEventListener('click', connectWallet);
            document.getElementById('create-token').addEventListener('click', createToken);
            
            // Check if MetaMask is available after a short delay
            setTimeout(() => {
                if (window.ethereum || window.web3) {
                    console.log("MetaMask is installed and available!");
                } else {
                    console.warn("MetaMask not detected on page load");
                }
            }, 1000);
        });

        // Connect to MetaMask wallet
        async function connectWallet() {
            try {
                console.log("Connect wallet clicked");
                console.log("Ethereum detection:", {
                    ethereum: typeof window.ethereum,
                    isMetaMask: window.ethereum?.isMetaMask,
                    web3: typeof window.web3
                });
                
                // More robust check for MetaMask
                if (typeof window.ethereum === 'undefined') {
                    showStatus('MetaMask not detected. Please make sure MetaMask is installed and this page is opened using a local server.', 'error');
                    console.log('Ethereum provider not found. Try using a local server instead of opening the file directly.');
                    return;
                }

                // Request accounts
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // Check if user connected any accounts
                if (accounts.length === 0) {
                    showStatus('Please connect to MetaMask!', 'error');
                    return;
                }

                // Create a provider
                provider = new ethers.BrowserProvider(window.ethereum);
                
                // Get the signer
                signer = await provider.getSigner();
                
                // Get the network
                const network = await provider.getNetwork();
                
                // Check if connected to Sepolia (chain ID 11155111)
                if (network.chainId !== 11155111n) {
                    showStatus('Please connect to Sepolia testnet!', 'error');
                    
                    // Prompt user to switch to Sepolia
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0xaa36a7' }], // Sepolia chain ID in hex
                        });
                    } catch (switchError) {
                        showStatus('Failed to switch to Sepolia network', 'error');
                        return;
                    }
                }
                
                // Initialize factory contract
                factoryContract = new ethers.Contract(
                    OGMA_FACTORY_ADDRESS,
                    FACTORY_ABI,
                    signer
                );
                
                // Show connected account
                const address = await signer.getAddress();
                document.getElementById('wallet-address').textContent = address;
                
                // Show wallet info and token form
                document.getElementById('wallet-info').classList.remove('hidden');
                document.getElementById('token-form').classList.remove('hidden');
                document.getElementById('connect-wallet').classList.add('hidden');
                
                showStatus('Wallet connected successfully!', 'success');
            } catch (error) {
                console.error('Connection error:', error);
                showStatus('Failed to connect wallet: ' + error.message, 'error');
            }
        }

        // Create a new token
        async function createToken() {
            try {
                // Get form values
                const tokenName = document.getElementById('token-name').value.trim();
                const tokenSymbol = document.getElementById('token-symbol').value.trim();
                const tokenURI = document.getElementById('token-uri').value.trim();
                const tokenDescription = document.getElementById('token-description').value.trim();
                
                // Validate inputs
                if (!tokenName || !tokenSymbol || !tokenURI || !tokenDescription) {
                    showStatus('Please fill in all fields!', 'error');
                    return;
                }
                
                // Show pending status
                showStatus('<div class="loader"></div> Creating token... Please confirm the transaction in MetaMask.', 'info');
                
                // Call createToken function on the contract
                const tx = await factoryContract.createToken(
                    tokenName,
                    tokenSymbol,
                    tokenURI,
                    tokenDescription
                );
                
                // Wait for the transaction to be mined
                showStatus('<div class="loader"></div> Transaction submitted! Waiting for confirmation...', 'info');
                const receipt = await tx.wait();
                
                console.log("Transaction receipt:", receipt);
                
                // Get the token address from the event
                // Handle different formats of transaction receipts
                let tokenAddress;
                try {
                    // First attempt: try to find the TokenMinted event and get the token address
                    if (receipt.logs && receipt.logs.length > 0) {
                        const event = receipt.logs.find(log => {
                            // Look for the event that contains the token address (first parameter)
                            return log.topics && log.topics.length > 1;
                        });
                        
                        if (event && event.args && event.args.length > 0) {
                            tokenAddress = event.args[0];
                        } else if (event && event.topics && event.topics.length > 1) {
                            // If we can't get it from args, try to decode from topics
                            tokenAddress = ethers.decodeEventLog(
                                ["address", "string", "string", "string", "string"],
                                event.data,
                                event.topics
                            )[0];
                        }
                    }
                    
                    // If we still don't have the token address, check if it's returned from the function
                    if (!tokenAddress && tx.data) {
                        // The createToken function returns the token address
                        tokenAddress = "Address will be available on the blockchain explorer";
                    }
                } catch (error) {
                    console.error("Error extracting token address:", error);
                    tokenAddress = "Check transaction on block explorer";
                }
                
                // Show success message and modal
                showStatus('Token created successfully!', 'success');
                
                // Set the token address and transaction hash in the modal
                document.getElementById('new-token-address').textContent = tokenAddress || "Check transaction on block explorer";
                document.getElementById('tx-hash').textContent = tx.hash;
                
                // Add link to view transaction on Sepolia Etherscan
                const txLink = `https://sepolia.etherscan.io/tx/${tx.hash}`;
                document.getElementById('tx-link').href = txLink;
                document.getElementById('tx-link').classList.remove('hidden');
                
                // Open the success modal
                const modal = M.Modal.getInstance(document.getElementById('tx-success-modal'));
                modal.open();
                
                // Reset the form
                document.getElementById('token-name').value = '';
                document.getElementById('token-symbol').value = '';
                document.getElementById('token-uri').value = '';
                document.getElementById('token-description').value = '';
                
                // Re-initialize Materialize form elements (to reset labels)
                M.updateTextFields();
                
            } catch (error) {
                console.error('Token creation error:', error);
                showStatus('Failed to create token: ' + error.message, 'error');
            }
        }

        // Show status message with appropriate styling
        function showStatus(message, type) {
            const statusElement = document.getElementById('status-message');
            statusElement.innerHTML = message;
            statusElement.className = 'status-message ' + type;
            statusElement.classList.remove('hidden');
        }
    </script>
</body>
</html>